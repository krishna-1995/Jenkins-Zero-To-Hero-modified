pipeline{
  agent any
    tools {
        maven 'Add Maven'
     }
stages{
  stage('checkout'){
    steps{
      sh 'echo password'
      //checkout scmGit(branches: [[name: '*/TEST']], extensions: [], userRemoteConfigs: [[name: 'github', url: 'https://github.com/krishna-1995/Jenkins-Zero-To-Hero-modified/']])
    }
  }
  stage('build and test'){
    steps{
      sh 'ls -lrth'
      sh 'cd java-maven-sonar-argocd-helm-k8s/spring-boot-app && mvn clean install'
    }
  }
 stage('static code analysys'){
   environment{
     SONAR_URL = "http://192.168.1.5:9000" 
   }
   steps{
     withCredentials([string(credentialsId: 'SonarQube', variable: 'SONAR_AUTH_TOKEN')]) {
       sh 'cd java-maven-sonar-argocd-helm-k8s/spring-boot-app && mvn sonar:sonar -Dsonar.login=$SONAR_AUTH_TOKEN -Dsonar.host.url-${SONAR_URL}'
        }
      }
     }
   stage('build and push docker image'){
     environment{
        DOCKER_IMAGE = "nagakrishna95/ultimate-cicd:${BUILD_NUMBER}"
        REGISTRY_CREDENTIALS = credentials('docker-cred')
     }
     steps{
       spript {
         sh 'cd java-maven-sonar-argocd-helm-k8s/spring-boot-app && docker build -t ${DOCKER_IMAGE} .'
         def dockerimage = docker.image("${DOCKER_IMAGE}")
         docker.withRegistry('https://index.docker.io/v1/', "docker-cred"){
         dockerImage.push() 
         }
        }
       }
   }
   stage('update the deployment file'){
      environment{
        GIT_REPO_NAME = "Jenkins-Zero-To-Hero-modified"
        GIT_USER_NAME = "krishna-1995"
      }
       steps{
          withCredentials([string(credentialsId: 'github', variable: 'GIT_AUTH_TOKEN')]) {
            sh 'git config user.email - "krishnakanuri1@gmail.com"'
            sh 'git config user.name = "krishna-1995"'
            BUILD_NUMBER=${Build_NUMBER}
            sh 'sed -i "s/replaceImageTag/${BUILD_NUMBER}/g" java-maven-sonar-argocd-helm-k8s/spring-boot-app-manifests/deployment.yml'
            sh 'git add java-maven-sonar-argocd-helm-k8s/spring-boot-app-manifests/deployment.yml'
            sh 'git commit -m "update new image version in deployment file" '
            sh 'git push https://${GIT_AUTH_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME} HEAD:TEST'
        } 
       }
   }
}
}
